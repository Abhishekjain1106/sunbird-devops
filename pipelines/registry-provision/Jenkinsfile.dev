#!groovy

node('build-slave') {

    currentBuild.result = "SUCCESS"

    try {
       stage('Checkout'){
          checkout scm
          sh('./pipelines/setupDevopsCode.sh')
       }

       stage('Pre-Build'){
         sh('./sunbird-devops/ansible/installDeps.sh')
         sh('git clone https://github.com/project-sunbird/open-saber.git sunbird-devops')
       }

       stage('Build'){
        steps {             
         sh '''
            cd sunbird-devops/open-saber/java
            mvn clean install
            cd ..
            ./configure-dependencies.sh
            cd java/registry 
            mvn clean install
            cp registry.jar ../../../
            pwd
            cd ../../../
            ls
            pwd
            ansible-playbook -i ansible/inventories/$ENV registry.yml --vault-password-file /home/ops/vault
            '''
        }
       }
    }
    
    catch (err) {
        currentBuild.result = "FAILURE"
        throw err
    }
}
